version: '2.1'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.2.2
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
  logstash:
    image: docker.elastic.co/logstash/logstash:6.2.2
    container_name: logstash
    ports:
      - "12201:12201/udp"
      - "9600:9600"
    command: -e 'input { gelf {} } output { elasticsearch { hosts => [ "elasticsearch:9200" ] } }'
    depends_on:
      - "elasticsearch"
    healthcheck:
      test: ["CMD", "curl", "-XGET", "http://localhost:9600"]
      interval: 30s
      timeout: 10s
      retries: 3
  kibana:
    image: docker.elastic.co/kibana/kibana:6.2.2
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
    depends_on:
      - "elasticsearch"
  registry:
    image: consul
    container_name: registry
    ports:
      - "8500:8500"
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    command: agent --dev -ui -client=0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      logstash:
        condition: service_healthy
  config:
    image: aostreetart/populateaeselconfig:latest
    container_name: config
    command: ./populate_consul.sh registry
    depends_on:
      registry:
        condition: service_healthy
  graphdb:
    image: neo4j
    container_name: graph-db
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - ${HOME}/neo4j/data:/data
    environment:
      NEO4J_AUTH: none
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    depends_on:
      logstash:
        condition: service_healthy
  documentdb:
    image: mongo
    container_name: document-db
    ports:
      - "27017:27017"
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    depends_on:
      logstash:
        condition: service_healthy
  queue:
    image: spotify/kafka
    container_name: queue
    ports:
      - "9092:9092"
      - "2181:2181"
    environment:
      ADVERTISED_PORT: 9092
      ADVERTISED_HOST: "queue"
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    depends_on:
      logstash:
        condition: service_healthy
  crazyivan:
    image: aostreetart/crazyivan:latest
    container_name: crazyivan
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    ports:
      - "5555:5555"
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    command: -consul-addr=registry:8500 -ip=localhost -advertised-host=crazyivan -port=5555 -log-conf=CrazyIvan/log4cpp.properties -wait=9
    depends_on:
      registry:
        condition: service_healthy
  clyman:
    image: aostreetart/clyman:latest
    container_name: clyman
    ports:
      - "5556:5556"
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    command: -consul-addr=registry:8500 -ip=localhost -advertised-host=clyman -port=5556 -log-conf=CLyman/log4cpp.properties -wait=9
    depends_on:
      registry:
        condition: service_healthy
  adrestia:
    image: aostreetart/adrestia:latest
    container_name: adrestia
    ports:
      - "5886:5886/udp"
      - "5885:5885"
    logging:
      driver: gelf
      options:
        gelf-address: udp://localhost:12201
    depends_on:
      registry:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_JSON: '{"logging":{"level":{"org":{"springframework":"INFO","mongodb":"INFO","hibernate":"INFO","apache":{"http":"INFO"}}}},"server":{"port":"5885","udp":{"port":"5886"},"mongo":{"host":"document-db","port":"27017"},"zmq":{"redlist":{"duration":"10"},"greylist":{"duration":"10"},"blacklist":{"duration":"10"},"retries":"3","timeout":"10000"}},"management":{"port":"5885","address":"127.0.0.1"},"spring":{"application":{"name":"Adrestia"},"profiles":{"active":"dev"},"cloud":{"consul":{"host":"registry","discovery":{"preferIpAddress":false}}},"http":{"multipart":{"max-file-size":"128MB","max-request-size":"128MB"}}}}'
